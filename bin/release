#!/bin/bash

set -e -u -o pipefail
set -x

declare -r WD="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd -P)"

info() {
    echo -e "\x1b[32m\xE2\x87\x92 $1\x1b[0m"
}

error() {
    echo -e "\x1b[97m\x1b[41m\x21\x1b[0m \x1b[31m$1\x1b[0m" 1>&2
    exit 1
}

get_version() {
    grep -Po '(version = )\"([\.0-9]+)\"' Cargo.toml | grep -Po '([\.0-9]+)'
}

get_branch() {
    git branch | grep -e "^\*" | awk '{print $2}'
}

get_access_token() {
    cat "$WD/github/.access_token"
}

get_payload() {
  local version=$1
  cat <<EOF
{
  "tag_name": "v$version",
  "target_commitish": "master",
  "name": "v$version",
  "body": "Release of version $version",
  "draft": false,
  "prerelease": false
}
EOF
}

main() {
    local owner="mickaelvieira"
    local repo="vagment"
    local endpoint="https://api.github.com/repos/$owner/$repo/releases"
    local version="$(get_version)"
    local token="$(get_access_token)"
    local payload=$(get_payload "$version")

    curl -v \
      -X POST \
      -H "Content-Type: application/json" \
      -H "Authorization: token $token" \
      --data "$payload" \
      "$endpoint"
}

main
